#!/bin/bash  
echo "==========================================="
echo "======== Build Script for Cabbage ========="
echo "==========================================="

echo "In order to build Cabbage you will need to have Csound installed, and"
echo "the Projucer from version 5.0 of JUCE built and installed."

echo "This scripts assumes that Csound is installed in the default location, i.e, includes files" 
echo "should be located in /user/local/include/csound while the Csound library itself should be"
echo "located in /user/local/lib "
echo "It is also assumes that the VST SDK is located in ~/SDKs/"
echo ""

if [ $1 == "debug" ]; then
  echo "Hello debug"
  ../../../JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer --resave ../../CabbageIDE.jucer
  mv Makefile MakeCabbageIDE
  make -f MakeCabbageIDE clean
  make -f MakeCabbageIDE -j8 
  cp ./build/Cabbage /usr/bin/Cabbage

  ../../../JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer --resave ../../CabbagePluginNoStandalone.jucer
  mv Makefile MakePluginEffect
  make -f MakePluginEffect clean 
  make -f MakePluginEffect -j8

  ../../../JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer --resave ../../CabbagePluginSynth.jucer
  mv Makefile MakePluginSynth
  make -f MakePluginSynth clean
  make -f MakePluginSynth -j8 
else
  #release mode  default

  mkdir -p ./install/bin ./install/images ./install/desktop

#================== build IDE ==================
  ../../../JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer --resave ../../CabbageIDE.jucer
  mv Makefile MakeCabbageIDE
  echo "$(tput bold)Building CabbageIDE…$(tput sgr0)"

  make -f MakeCabbageIDE clean CONFIG=Release
  make -f MakeCabbageIDE -j8 CONFIG=Release
  cp ./build/Cabbage ./install/bin/Cabbage

#================== build plugin - no standalone ==================
  ../../../JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer --resave ../../CabbagePluginNoStandalone.jucer
  mv Makefile MakePluginEffect
  echo "$(tput bold)Building PluginEffect…$(tput sgr0)"

  #build LinuxVST
  make -f MakePluginEffect clean CONFIG=Release
  make -f MakePluginEffect -j8 CONFIG=Release
  cp ./build/CabbagePlugin.so ./install/bin/CabbagePluginEffect.so

  #build LV2
  ../../LV2/addLV2Support.sh
  echo "include ../../LV2/LV2.mk" >> MakePluginEffect
  make -f MakePluginEffect clean CONFIG=Release
  make -f MakePluginEffect -j8 CONFIG=Release
  cp -rf ./build/CabbagePlugin.lv2 ./install/bin/CabbagePluginEffect.lv2
  mv ./install/bin/CabbagePluginEffect.lv2/CabbagePlugin.so ./install/bin/CabbagePluginEffect.lv2/CabbagePluginEffect.so
  mv ./install/bin/CabbagePluginEffect.lv2/CabbagePlugin.ttl ./install/bin/CabbagePluginEffect.lv2/CabbagePluginEffect.ttl
  

#================== build plugin synth ==================
  ../../../JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer --resave ../../CabbagePluginSynth.jucer
  mv Makefile MakePluginSynth
  echo "$(tput bold)Building PluginSynth…$(tput sgr0)"

  #build LinuxVST Synth
  make -f MakePluginSynth clean CONFIG=Release
  make -f MakePluginSynth -j8 CONFIG=Release
  cp ./build/CabbagePlugin.so ./install/bin/CabbagePluginSynth.so


  #build LV2
  ../../LV2/addLV2Support.sh
  echo "include ../../LV2/LV2.mk" >> MakePluginSynth
  make -f MakePluginSynth clean CONFIG=Release
  make -f MakePluginSynth -j8 CONFIG=Release
  cp -rf ./build/CabbagePlugin.lv2 ./install/bin/CabbagePluginSynth.lv2
  mv ./install/bin/CabbagePluginSynth.lv2/CabbagePlugin.so ./install/bin/CabbagePluginSynth.lv2/CabbagePluginSynth.so
  mv ./install/bin/CabbagePluginSynth.lv2/CabbagePlugin.ttl ./install/bin/CabbagePluginSynth.lv2/CabbagePluginSynth.ttl 

#================== build Cabbage lite ==================
  # ../../../JUCE/extras/Projucer/Builds/LinuxMakefile/build/Projucer --resave ../../CabbageLite.jucer
  # mv Makefile MakeCabbageLite
  # echo "$(tput bold)Building CabbageLite…$(tput sgr0)"

  # make -f MakeCabbageLite clean CONFIG=Release
  # make -f MakeCabbageLite -j8 CONFIG=Release
  # cp ./build/CabbageLite ./install/bin/CabbageLite
fi  

echo "$(tput bold)Copying over docs and icons…$(tput sgr0)"
cp ./../opcodes.txt ./install/bin/opcodes.txt
cp ./../../Images/cabbage.png ./install/images/cabbage.png
cp ./../../Images/cabbage.png ./install/images/cabbagelite.png
cp -rf ../../Examples ./install/
cp -rf ../../Themes ./install/

#g++ ../../Source/testCsoundFile.cpp -o testCsoundFile -I"/usr/local/include/csound" -I"/usr/include/csound" -lcsound64
# cp testCsoundFile ./install/bin/testCsoundFile
#cp -rf ../../Docs/_book CabbageBuild/Docs

sed "s@CURRENTDIR@$(pwd)@" Cabbage.desktop > ./install/desktop/cabbage.desktop
sed "s@CURRENTDIR@$(pwd)@" Cabbage.desktop > ./install/desktop/cabbageLite.desktop
# sed "s@CURRENTDIR@$(pwd)@" dummy.desktop > CabbageBuild/cabbagelite.desktop
